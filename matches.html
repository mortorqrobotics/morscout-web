<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MorScout - All Matches</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Exo+2:100' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <link rel="stylesheet" href="css/settings.css" type="text/css">

</head>

<body>

    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">MorScout</a>
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#MorScoutNav" id="toggle-button">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="MorScoutNav">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="matches.html" title="List of all matches">All Matches</a></li>
                    <li><a href="teams.html" title="List of all teams">Team List</a></li>
                    <li><a href="settings.html" title="Configure the settings">Settings</a></li>
                </ul>
                <input type="text" placeholder="Search Users" class="nav-tbox"></input>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="help.html" title="Need help?">Help</a></li>
                    <li><a href="feedback.html" title="Give team 1515 your feedback!">Feedback</a></li>
                    <li><a href="profile.html"  title="User Profile">Profile</a></li>
                    <li id="UserDropdown" class="dropdown">
                        <a id="logoutButton" href="login.html">Log in</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="page-title">
        <div class="container">
            <h1>All Matches</h1>
            <input type="text" id="search" class="settings-box text-input" placeholder="search.."></input>
            <table class="matches-table">
                <tr id="first-row">
                    <th>#</th>
                    <th>Time</th>
                    <th>Progress</th>
                    <th colspan="3" class="matchesTableHide redTeamHeader">Red Teams</th>
                    <th colspan="3" class="matchesTableHide blueTeamHeader">Blue Teams</th>
                </tr>
            </table>
        </div>
    </div>
    <h2 id="loading">Loading...</h2>

    <script src="js/jquery-2.1.3.min.js"></script>
    <!-- JQuery has to load before the table -->
    <script src="js/matchesTable.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/main.js" type="text/javascript"></script>
    <script>


        function getMatches() {
            $.post("/getMatchesForCurrentRegional", {}, function(response) {
                var matches = JSON.parse(response);
                matches.sort(function (a, b) {
                  if (a.time > b.time) {
                    return 1;
                  }
                  if (a.time < b.time) {
                    return -1;
                  }
                  return 0;
                });
                var matchesTable = $(".matches-table");
                $("#loading").hide();
                for (var i = 0; i < matches.length; i++) {
                    if (matches[i].comp_level == "qm"){
                        var matchNumber = matches[i].match_number;
                        var time = standardizeTime(matches[i].time);
                        var progress = "none"; //change later obv
                        var regional = matches[i].event_key;
                        var blueAlliance = matches[i].alliances.blue.teams;
                        var redAlliance = matches[i].alliances.red.teams;
                        var allTeams = redAlliance.concat(blueAlliance);
                        var tr = $(document.createElement("tr"));
                        tr.mouseenter(function(){
                            $(this).addClass("table-hover");
                        });
                        tr.mouseleave(function(){
                            $(this).removeClass("table-hover");
                        });
                        tr.click(function(){
                            var subtds = $(this).find("td");
                            //var newURL = "report.html/?match=" + matchNumber + "&regional=" + regional + "&r1=" + redAlliance[0] + "&r2=" + redAlliance[1] + "&r3=" + redAlliance[2] + "&b1=" + blueAlliance[0] + "&b2=" + blueAlliance[1] + "&b3=" + blueAlliance[2];//no work
                            var newURL = "report.html?match=" + subtds.eq(0).html();
                            location = newURL;
                        });
                        if (i % 2 != 0) tr.addClass("odd-row");
                        var dps = [matchNumber, time, progress];
                        var tds = [];
                        for (var j = 0; j < 3; j++) {
                            var td = $(document.createElement("td"));
                            td.html(dps[j]);
                            tr.append(td);
                        }
                        for (var j = 0; j < redAlliance.length; j++) {
                            var td = $(document.createElement("td"));
                            td.html(redAlliance[j].substring(3));
                            td.addClass("matchesTableHide");
                            tds.push(td);
                        }
                        for (var j = 0; j < blueAlliance.length; j++) {
                            var td = $(document.createElement("td"));
                            td.html(blueAlliance[j].substring(3));
                            td.addClass("matchesTableHide")
                            tds.push(td);
                        }
                        for (var j = 0; j < 6; j++){
                            var currentTeamNumber = allTeams[j].substring(3);
                            if (currentTeamNumber == localStorage.teamNumber){
                                tds[j].addClass("selfTeamHighlight");
                            }
                            else {
                                var ally = false;
                                var enemy = false;
                                for (var k = 0; k < matches.length; k++){
                                    var currentMatch = matches[k];
                                    if (currentMatch.match_number > matchNumber){
                                        var selfRed = ~currentMatch.alliances.red.teams.indexOf("frc" + localStorage.teamNumber);
                                        var selfBlue = ~currentMatch.alliances.blue.teams.indexOf("frc" + localStorage.teamNumber);
                                        var otherRed = ~currentMatch.alliances.red.teams.indexOf("frc" + currentTeamNumber);
                                        var otherBlue = ~currentMatch.alliances.blue.teams.indexOf("frc" + currentTeamNumber);
                                        if((selfRed && otherRed) || (selfBlue && otherBlue)) {
          									ally = true;
          								}
          								if((selfRed && otherBlue) || (selfBlue && otherRed)) {
          									enemy = true;
          								}
                                    }
                                }
                                if(ally && enemy) {
          							tds[j].addClass("frenemyTeamHighlight");
          						}
          						else if(ally) {
          							tds[j].addClass("allyTeamHighlight");
          						}
          						else if(enemy) {
          							tds[j].addClass("enemyTeamHighlight");
          						}
                            }
                            tr.append(tds[j]);
                        }

                        matchesTable.append(tr);
                    }
                }
            });
        }
        $('#search').keyup(function() {
            var rows = $('.matches-table tr');
    		$('tr').removeClass('odd_row');
    	    var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
    	    if(val==""){
    	    	//$("tr:odd").addClass("odd-row");
    	    }
    	    rows.show().filter(function() {
    	        var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
    	        return !~text.indexOf(val);
    	    }).hide();
    	    $("#first-row").show();
    	});



        getMatches();
    </script>

</body>

</html>

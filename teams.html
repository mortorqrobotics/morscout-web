<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MorScout - All Teams</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Exo+2:100' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <link rel="stylesheet" href="css/settings.css" type="text/css">

</head>

<body>

    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">MorScout</a>
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#MorScoutNav" id="toggle-button">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="MorScoutNav">
                <ul class="nav navbar-nav">
                    <li><a href="matches.html" title="List of all matches">All Matches</a></li>
                    <li class="active"><a href="teams.html" title="List of all teams">Team List</a></li>
                    <li><a href="settings.html" title="Configure the settings">Settings</a></li>
                </ul>
                <input type="text" placeholder="Search Users" class="nav-tbox"></input>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="help.html" title="Need help?">Help</a></li>
                    <li><a href="feedback.html" title="Give team 1515 your feedback!">Feedback</a></li>
                    <li><a href="profile.html" title="User Profile">Profile</a></li>
                    <li id="UserDropdown" class="dropdown">
                        <a id="logoutButton" href="login.html">Log in</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="page-title">
        <div class="container">
            <h1 style="display: inline-block; margin-right: .2em;">All Teams</h1>
            <h1 style="display: inline-block;" id="num-of-teams"></h1>
            <br/>
            <input type="text" id="search" class="settings-box text-input" placeholder="search.."></input>
        </div>
    </div>
    <h2 id="loading">Loading...</h2>

    <div id="dropdown-holder" style="text-align: center;">

    </div>



    <script src="js/jquery-2.1.3.min.js"></script>
    <!-- JQuery has to load before the table -->
    <!-- <script src="js/teamsTable.js"></script> -->
    <script src="js/bootstrap.min.js"></script>
    <table class="teams-table">
    </table>
    <script src="js/main.js" type="text/javascript"></script>

    <script>
        var allTeams = []; //keep

        $.post("/getScoutForm", {
            context: "match"
        }, function(responseMatches) {
            $.post("/getScoutForm", {
                context: "pit"
            }, function(responsePit) {
                if (responseMatches != "fail" && responsePit != "fail") {
                    var scoutFormDPS = JSON.parse(responseMatches).concat(JSON.parse(responsePit));
                    var select = $(document.createElement("select"));
                    select.addClass("creator-dropdown sort-drop");
                    select.attr("required", "true");
                    var options = [{
                        value: "teamNumber",
                        name: "Team Number"
                    }, {
                        value: "officialRanking",
                        name: "Official Ranking"
                    }];
                    for (var i = 0; i < scoutFormDPS.length; i++) {
                        var type = scoutFormDPS[i].type;
                        var name = scoutFormDPS[i].name;
                        if (type == "number") {
                            options.push({
                                value: name,
                                name: name
                            });
                        }
                    }
                    for (var i = 0; i < options.length; i++) {
                        var option = $(document.createElement("option"));
                        option.attr("value", options[i].value);
                        option.html(options[i].name);
                        select.append(option);
                    }
                    $("#dropdown-holder").append(select);
                } else {
                    alert("Failed to retrieve team list");
                }
            })
        });

        function loadByNumber() {
            $.post("/getTeamListForRegional", {}, function(response) {
                if (response != "fail") {
                    var teams = JSON.parse(response);
                    allTeams = teams;
                    teams.sort(function(a, b) {
                        if (a.team_number > b.team_number) {
                            return 1;
                        }
                        if (a.team_number < b.team_number) {
                            return -1;
                        }
                        return 0;
                    });
                    $("#loading").hide();
                    var table = $(".teams-table");
                    table.empty();
                    var firstRow = $(document.createElement("tr"));
                    firstRow.addClass("first-row");
                    var th1 = $(document.createElement("th"));
                    th1.html("Team #");
                    var th2 = $(document.createElement("th"));
                    th2.html("Name");
                    firstRow.append(th1);
                    firstRow.append(th2);
                    table.append(firstRow);
                    for (var i = 0; i < teams.length; i++) {
                        var teamNumber = teams[i].team_number;
                        var teamName = teams[i].nickname;
                        var tr = $(document.createElement("tr"));
                        if (i % 2 != 0) tr.addClass("odd-row");
                        tr.attr("id", teamNumber);
                        var thNumber = $(document.createElement("th"));
                        thNumber.html(teamNumber)
                        var thName = $(document.createElement("th"));
                        thName.html(teamName);
                        tr.append(thNumber);
                        tr.append(thName);
                        table.append(tr);
                    }
                } else {
                    alert("Failed to retrieve team list");
                }
            });
        }

        function loadByRanking() {
            $.post("/getRankingsForRegional", {}, function(response) {
                if (response != "fail") {
                    var teams = JSON.parse(response);
                    teams.sort(function(a, b) {
                        return (parseInt(a[0]) - parseInt(b[0]));
                    });
                    var table = $(".teams-table");
                    table.empty();
                    var firstRow = $(document.createElement("tr")); //loop later
                    firstRow.addClass("first-row");
                    var th1 = $(document.createElement("th"));
                    th1.html("Team #");
                    var th2 = $(document.createElement("th"));
                    th2.html("Name");
                    var th3 = $(document.createElement("th"));
                    th3.html("Rank");
                    firstRow.append(th3);
                    firstRow.append(th1);
                    firstRow.append(th2);
                    table.append(firstRow);
                    $("#loading").hide();
                    for (var i = 1; i < teams.length; i++) {
                        var teamNumber = parseInt(teams[i][1]);
                        for (var j = 0; j < allTeams.length; j++) {
                            if (allTeams[j].team_number == teamNumber) {
                                var teamName = allTeams[j].nickname;
                                var tr = $(document.createElement("tr"));
                                if (i % 2 != 0) tr.addClass("odd-row");
                                tr.attr("id", teamNumber);
                                var thNumber = $(document.createElement("th"));
                                thNumber.html(teamNumber)
                                var thName = $(document.createElement("th"));
                                thName.html(teamName);
                                var thRank = $(document.createElement("th"));
                                thRank.html(i);
                                tr.append(thRank);
                                tr.append(thNumber);
                                tr.append(thName);
                                table.append(tr);
                                break;
                            }
                        }
                    }
                } else {
                    alert("Failed to retrieve teams");
                }
            });
        }

        function loadByDataPoint(dpName) {
            $.post("/getSortedTeamAvgs", {
                sortBy: dpName
            }, function(response) {
                if (typeof(JSON.parse(response)) == "object") {
                    var teams = JSON.parse(response);
                    var table = $(".teams-table");
                    table.empty();
                    var firstRow = $(document.createElement("tr"));
                    firstRow.addClass("first-row");
                    var th1 = $(document.createElement("th"));
                    th1.html("Team #");
                    var th2 = $(document.createElement("th"));
                    th2.html("Name");
                    var th3 = $(document.createElement("th"));
                    th3.html("Average");
                    firstRow.append(th1);
                    firstRow.append(th2);
                    firstRow.append(th3);
                    table.append(firstRow);
                    $("#loading").hide();
                    for (var i = 0; i < teams.length; i++) {
                        var teamNumber = parseFloat(teams[i].key);
                        var dpValue = parseFloat(teams[i].value);
                        for (var j = 0; j < allTeams.length; j++) {
                            if (allTeams[j].team_number == teamNumber) {
                                var teamName = allTeams[j].nickname;
                                var tr = $(document.createElement("tr"));
                                if (i % 2 != 0) tr.addClass("odd-row");
                                tr.attr("id", teamNumber);
                                var thNumber = $(document.createElement("th"));
                                thNumber.html(teamNumber)
                                var thName = $(document.createElement("th"));
                                thName.html(teamName);
                                var thValue = $(document.createElement("th"));
                                thValue.html(dpValue);
                                tr.append(thNumber);
                                tr.append(thName);
                                tr.append(thValue);
                                table.append(tr);
                                break;
                            }
                        }
                    }
                } else {
                    alert("Failed to retrieve team list");
                }
            });
        }
        $(document).on("change", ".sort-drop", function() {
            var type = $(this).val();
            if (type == "teamNumber") {
                loadByNumber();
            } else if (type == "officialRanking") {
                loadByRanking();
            } else {
                loadByDataPoint(type);
            }
        });

        loadByNumber();
        $(document).on("mouseenter","tr:not(.first-row)", function(){
            $(this).addClass('table-hover');
        });
        $(document).on("mouseleave","tr:not(.first-row)", function(){
            $(this).removeClass('table-hover');
        });



        $(document).on("click","tr:not(.first-row)", function(){
            localStorage.pitTeam = $(this).children(":first").text();
            location = "reportTeam.html?" + getQS({
                "team": $(this).children(":first").text(),
                "name": $(this).children(":first").next().text()
            });
        });


        $(document).on("keyup", "#search", function() {
            $('tr').removeClass('odd-row');
            var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
            if (val == "") {
                $("tr:odd").addClass("odd-row");
            }
            var $rows = $('.teams-table tr');
            $rows.show().filter(function() {
                var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                return !~text.indexOf(val);
            }).hide();
        });
    </script>

</body>

</html>
